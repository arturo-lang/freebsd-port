name: Test FreeBSD Port

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-freebsd-port:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test port on FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          prepare: |
            pkg update -f
            pkg install -y git
          
          run: |
            echo "=========================================="
            echo "FreeBSD Port Test for Arturo"
            echo "=========================================="
            echo "FreeBSD Version:"
            freebsd-version
            echo ""
            
            # Create minimal ports infrastructure
            mkdir -p /usr/ports/Mk
            cd /tmp
            git clone --depth 1 --filter=blob:none --sparse https://git.freebsd.org/ports.git
            cd ports
            git sparse-checkout set Mk Templates
            cp -r Mk/* /usr/ports/Mk/
            cp -r Templates /usr/ports/
            
            # Copy our port
            mkdir -p /usr/ports/lang/arturo
            cp -r $GITHUB_WORKSPACE/lang/arturo/* /usr/ports/lang/arturo/
            cd /usr/ports/lang/arturo
            
            echo "=========================================="
            echo "1. Testing port fetch..."
            echo "=========================================="
            make fetch
            echo ""
            
            echo "=========================================="
            echo "2. Testing port checksum..."
            echo "=========================================="
            make checksum
            echo ""
            
            echo "=========================================="
            echo "3. Testing port extract..."
            echo "=========================================="
            make extract
            echo ""
            
            echo "=========================================="
            echo "4. Verifying extracted contents..."
            echo "=========================================="
            echo "Work directory contents:"
            ls -la work/
            echo ""
            echo "Extracted directory:"
            find work -type f -name "arturo"
            echo ""
            
            echo "=========================================="
            echo "5. Installing binary directly (skip dependencies for CI)..."
            echo "=========================================="
            ARTURO_BIN=$(find work -type f -name "arturo" -executable)
            if [ -n "$ARTURO_BIN" ]; then
                install -m 755 "$ARTURO_BIN" /usr/local/bin/arturo
                echo "✅ Binary installed to /usr/local/bin/arturo"
            else
                echo "❌ Could not find arturo binary"
                exit 1
            fi
            echo ""
            
            echo "=========================================="
            echo "6. Testing installed binary..."
            echo "=========================================="
            which arturo
            file /usr/local/bin/arturo
            ldd /usr/local/bin/arturo || echo "Note: ldd may show missing dependencies (expected in CI)"
            arturo --version || echo "⚠️  Binary needs runtime dependencies"
            echo ""
            
            echo "=========================================="
            echo "✅ Port structure and binary extraction successful!"
            echo "=========================================="

  verify-structure:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Verify port structure
        run: |
          echo "=========================================="
          echo "Verifying Port Structure"
          echo "=========================================="
          
          if [ ! -f "lang/arturo/Makefile" ]; then
            echo "❌ ERROR: Makefile missing"
            exit 1
          fi
          echo "✅ Makefile found"
          
          if [ ! -f "lang/arturo/distinfo" ]; then
            echo "❌ ERROR: distinfo missing"
            exit 1
          fi
          echo "✅ distinfo found"
          
          if [ ! -f "lang/arturo/pkg-descr" ]; then
            echo "❌ ERROR: pkg-descr missing"
            exit 1
          fi
          echo "✅ pkg-descr found"
          
          echo ""
          echo "Checking Makefile contents..."
          
          if ! grep -q "PORTNAME=" lang/arturo/Makefile; then
            echo "❌ ERROR: PORTNAME not found"
            exit 1
          fi
          echo "✅ PORTNAME defined"
          
          if ! grep -q "DISTVERSION=" lang/arturo/Makefile; then
            echo "❌ ERROR: DISTVERSION not found"
            exit 1
          fi
          echo "✅ DISTVERSION defined"
          
          if ! grep -q "MAINTAINER=" lang/arturo/Makefile; then
            echo "❌ ERROR: MAINTAINER not found"
            exit 1
          fi
          echo "✅ MAINTAINER defined"
          
          if ! grep -q "COMMENT=" lang/arturo/Makefile; then
            echo "❌ ERROR: COMMENT not found"
            exit 1
          fi
          echo "✅ COMMENT defined"
          
          if ! grep -q "LICENSE=" lang/arturo/Makefile; then
            echo "❌ ERROR: LICENSE not found"
            exit 1
          fi
          echo "✅ LICENSE defined"
          
          if ! grep -q "^WWW=" lang/arturo/Makefile; then
            echo "❌ ERROR: WWW not found in Makefile"
            exit 1
          fi
          echo "✅ WWW defined in Makefile"
          
          echo ""
          echo "Checking distinfo format..."
          
          if ! grep -q "TIMESTAMP" lang/arturo/distinfo; then
            echo "❌ ERROR: TIMESTAMP missing"
            exit 1
          fi
          echo "✅ TIMESTAMP found"
          
          if ! grep -q "SHA256" lang/arturo/distinfo; then
            echo "❌ ERROR: SHA256 missing"
            exit 1
          fi
          echo "✅ SHA256 found"
          
          if ! grep -q "SIZE" lang/arturo/distinfo; then
            echo "❌ ERROR: SIZE missing"
            exit 1
          fi
          echo "✅ SIZE found"
          
          echo ""
          echo "Checking pkg-descr..."
          
          if grep -q "^WWW:" lang/arturo/pkg-descr; then
            echo "❌ ERROR: WWW should be in Makefile, not pkg-descr"
            exit 1
          fi
          echo "✅ WWW correctly in Makefile"
          
          DESC_LINES=$(wc -l < lang/arturo/pkg-descr)
          if [ $DESC_LINES -lt 3 ]; then
            echo "❌ ERROR: pkg-descr too short"
            exit 1
          fi
          echo "✅ pkg-descr has sufficient content ($DESC_LINES lines)"
          
          echo ""
          echo "=========================================="
          echo "✅ All structure checks passed!"
          echo "=========================================="

  check-download:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Verify distfile is downloadable
        run: |
          echo "=========================================="
          echo "Verifying Distfile Download"
          echo "=========================================="
          
          FULL_URL="https://arturo-lang.io/files/arturo-0.10.0-freebsd-amd64.zip"
          
          echo "Testing download from: $FULL_URL"
          echo ""
          
          if curl --fail --head --silent "$FULL_URL" > /dev/null; then
            echo "✅ Distfile is accessible"
            
            curl -L -o /tmp/arturo.zip "$FULL_URL"
            
            EXPECTED_SHA256=$(grep "^SHA256" lang/arturo/distinfo | awk '{print $4}' | tr -d ')')
            ACTUAL_SHA256=$(sha256sum /tmp/arturo.zip | awk '{print $1}')
            
            echo ""
            echo "Expected SHA256: $EXPECTED_SHA256"
            echo "Actual SHA256:   $ACTUAL_SHA256"
            
            if [ "$EXPECTED_SHA256" = "$ACTUAL_SHA256" ]; then
              echo "✅ Checksum matches!"
            else
              echo "❌ ERROR: Checksum mismatch!"
              exit 1
            fi
            
            EXPECTED_SIZE=$(grep "^SIZE" lang/arturo/distinfo | awk '{print $4}' | tr -d ')')
            ACTUAL_SIZE=$(stat -c%s /tmp/arturo.zip)
            
            echo ""
            echo "Expected size: $EXPECTED_SIZE bytes"
            echo "Actual size:   $ACTUAL_SIZE bytes"
            
            if [ "$EXPECTED_SIZE" = "$ACTUAL_SIZE" ]; then
              echo "✅ Size matches!"
            else
              echo "❌ ERROR: Size mismatch!"
              exit 1
            fi
          else
            echo "❌ ERROR: Distfile not accessible"
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "✅ Download verification passed!"
          echo "=========================================="